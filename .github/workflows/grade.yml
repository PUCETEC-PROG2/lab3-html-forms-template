name: Autocalificaci√≥n Lab 3

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  grade:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
      
    - name: Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Instalar dependencias
      run: npm ci
      
    - name: Ejecutar autocalificaci√≥n
      id: grade
      run: |
        npm run grade || true
        
    - name: Leer resultados
      id: results
      run: |
        if [ -f calificacion.json ]; then
          SCORE=$(cat calificacion.json | jq -r '.score')
          PERCENTAGE=$(cat calificacion.json | jq -r '.percentage')
          PASSED=$(cat calificacion.json | jq -r '.testsPassed')
          TOTAL=$(cat calificacion.json | jq -r '.testsTotal')
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "percentage=$PERCENTAGE" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
        else
          echo "score=0" >> $GITHUB_OUTPUT
          echo "percentage=0" >> $GITHUB_OUTPUT
          echo "passed=0" >> $GITHUB_OUTPUT
          echo "total=0" >> $GITHUB_OUTPUT
        fi
        
    - name: Crear comentario de resultado
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          
          let comentario = '## üìä Resultado de Autocalificaci√≥n\n\n';
          
          if (fs.existsSync('calificacion.json')) {
            const resultado = JSON.parse(fs.readFileSync('calificacion.json', 'utf8'));
            
            const emoji = resultado.score >= 9 ? 'üåü' : 
                         resultado.score >= 7 ? 'üëç' : 
                         resultado.score >= 5 ? 'üìö' : 'üí™';
            
            comentario += `### ${emoji} Calificaci√≥n: **${resultado.score}/${resultado.maxScore}** puntos (${resultado.percentage}%)\n\n`;
            comentario += `‚úÖ Pruebas aprobadas: **${resultado.testsPassed}/${resultado.testsTotal}**\n\n`;
            comentario += '#### üìã Desglose por secci√≥n:\n\n';
            comentario += '| Secci√≥n | Pruebas | Puntos |\n';
            comentario += '|---------|---------|--------|\n';
            
            for (const [seccion, datos] of Object.entries(resultado.details)) {
              const status = datos.passed === datos.total ? '‚úÖ' : '‚ùå';
              const puntos = seccion.match(/\(([0-9.]+) punto/);
              const puntosMax = puntos ? puntos[1] : '?';
              const puntosObtenidos = ((datos.passed / datos.total) * parseFloat(puntosMax)).toFixed(2);
              comentario += `| ${status} ${seccion} | ${datos.passed}/${datos.total} | ${puntosObtenidos}/${puntosMax} |\n`;
            }
            
            if (resultado.score >= 9) {
              comentario += '\nüéâ **¬°EXCELENTE!** Has dominado el laboratorio.';
            } else if (resultado.score >= 7) {
              comentario += '\nüëè **¬°MUY BIEN!** Buen trabajo.';
            } else if (resultado.score >= 5) {
              comentario += '\nüìñ **APROBADO.** Revisa los puntos fallidos para mejorar.';
            } else {
              comentario += '\nüí™ **Necesitas repasar.** ¬°Sigue intentando!';
            }
          } else {
            comentario += '‚ùå No se pudo generar el reporte de calificaci√≥n.\n';
            comentario += 'Verifica que el archivo `index.html` exista y las pruebas se ejecuten correctamente.';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comentario
          });
          
    - name: Crear badge de calificaci√≥n
      run: |
        mkdir -p badges
        SCORE="${{ steps.results.outputs.score }}"
        PERCENTAGE="${{ steps.results.outputs.percentage }}"
        
        if (( $(echo "$SCORE >= 9" | bc -l) )); then
          COLOR="brightgreen"
          MESSAGE="Excelente"
        elif (( $(echo "$SCORE >= 7" | bc -l) )); then
          COLOR="green"
          MESSAGE="Muy Bien"
        elif (( $(echo "$SCORE >= 5" | bc -l) )); then
          COLOR="yellow"
          MESSAGE="Aprobado"
        else
          COLOR="red"
          MESSAGE="Necesita Mejorar"
        fi
        
        echo "![Calificaci√≥n](https://img.shields.io/badge/Calificaci√≥n-${SCORE}%2F10-${COLOR}?style=for-the-badge)" > badges/grade.md
        echo "![Estado](https://img.shields.io/badge/Estado-${MESSAGE}-${COLOR}?style=for-the-badge)" >> badges/grade.md
        
    - name: Subir reporte como artefacto
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: reporte-calificacion
        path: |
          calificacion.json
          test-results.json
          badges/
        retention-days: 90
        
    - name: Resumen en GitHub
      if: always()
      run: |
        echo "## üìä Resumen de Autocalificaci√≥n" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f calificacion.json ]; then
          SCORE=$(cat calificacion.json | jq -r '.score')
          MAX_SCORE=$(cat calificacion.json | jq -r '.maxScore')
          PERCENTAGE=$(cat calificacion.json | jq -r '.percentage')
          PASSED=$(cat calificacion.json | jq -r '.testsPassed')
          TOTAL=$(cat calificacion.json | jq -r '.testsTotal')
          
          if (( $(echo "$SCORE >= 9" | bc -l) )); then
            EMOJI="üåü"
            MENSAJE="¬°EXCELENTE! Has dominado el laboratorio."
          elif (( $(echo "$SCORE >= 7" | bc -l) )); then
            EMOJI="üëç"
            MENSAJE="¬°MUY BIEN! Buen trabajo."
          elif (( $(echo "$SCORE >= 5" | bc -l) )); then
            EMOJI="üìö"
            MENSAJE="APROBADO. Revisa los puntos fallidos."
          else
            EMOJI="üí™"
            MENSAJE="Necesitas repasar. ¬°Sigue intentando!"
          fi
          
          echo "### ${EMOJI} Calificaci√≥n Final" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Puntaje:** ${SCORE}/${MAX_SCORE} puntos" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Porcentaje:** ${PERCENTAGE}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pruebas:** ${PASSED}/${TOTAL} aprobadas" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${MENSAJE}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üì• Descarga el reporte completo desde los artefactos de esta ejecuci√≥n." >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **Error:** No se pudo generar el reporte de calificaci√≥n." >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Verificar aprobaci√≥n
      if: always()
      run: |
        if [ -f calificacion.json ]; then
          SCORE=$(cat calificacion.json | jq -r '.score')
          if (( $(echo "$SCORE < 5" | bc -l) )); then
            echo "‚ùå Calificaci√≥n insuficiente: $SCORE/10"
            exit 1
          fi
        fi
